{% extends 'base.html' %}
{% load static %}

{% block content %}
<section class="my-6 md:my-16">
  <br><br>
  <div class="container mx-auto md:px-36">
    <!-- ============================ COMPONENT 1 ================================= -->
    <h4 class="text-center text-2xl font-bold mb-8">Review Your Order and Make Payment</h4>
    <div class="flex flex-col lg:flex-row gap-8">
      <!-- Left Column: Billing Address, Payment Method, and Review Products -->
      <div class="lg:w-3/4">
        <!-- Billing Address -->
        <div class="border overflow-hidden">
          <div class="px-6 py-4">
            <h5 class="text-xl font-bold mb-4">Billing Address</h5>
            <p class="text-gray-700 mb-2">{{order.full_name}}</p>
            <p class="text-gray-700 mb-2">{{order.full_address}}</p>
            <p class="text-gray-700 mb-2">{{order.city}}, {{order.state}}</p>
            <p class="text-gray-700 mb-2">{{order.country}}</p>
            <p class="text-gray-700 mb-2">{{order.email}}</p>
            <p class="text-gray-700 mb-2">{{order.phone}}</p>
            {% if order.order_note %}
            <b class="text-gray-700">Order Note: </b> {{order.order_note}}
            {% endif %}
          </div>
        </div>

        <!-- Review Products -->
        <div class="border overflow-hidden mt-6">
          <div class="px-6 py-4">
            <h5 class="text-xl font-bold mb-4">Review Products</h5>
            <table class="w-full text-left">
              <tbody>
                {% for cart_item in cart_items %}
                <tr class="border-b">
                  <td class="py-4">
                    <div class="flex items-center">
                      <div class="w-16 h-16 mr-4">
                        <img src="{{ cart_item.product.images.url }}" class="w-full h-full object-cover rounded-lg" alt="{{ cart_item.product.product_name }}">
                      </div>
                      <div>
                        <a href="{{ cart_item.product.get_url }}" class="text-lg font-semibold hover:text-primary">{{ cart_item.product.product_name }}</a>
                        <p class="text-sm text-gray-500">
                          {% if cart_item.variations.all %}
                          {% for item in cart_item.variations.all %}
                          {{ item.variation_category | capfirst }} : {{ item.variation_value | capfirst }}<br>
                          {% endfor %}
                          {% endif %}
                        </p>
                      </div>
                    </div>
                  </td>
                  <td class="py-4">
                    <div class="text-lg font-semibold">₹{{ cart_item.sub_total }}</div>
                    <small class="text-sm text-gray-500">₹{{ cart_item.product.price }} * {{ cart_item.quantity }} qty</small>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Right Column: Order Summary -->
      <div class="lg:w-1/4">
        <p class="py-5 text-gray-400 text-sm">BILLING DETAILS</p>
        <div>
          <div class="flex justify-between border p-2">
            <div class="text-gray-500 text-sm">Total Price</div>
            <div class="text-gray-800 font-semibold text-sm">₹{{ total }}</div>
          </div>
          <div class="flex justify-between border p-2">
            <div class="text-gray-500 text-sm">Tax</div>
            <div class="text-gray-800 font-semibold text-sm">₹{{ tax }}</div>
          </div>
          <div class="flex justify-between border p-2">
            <div class="text-gray-800 font-semibold text-sm">Grand Total</div>
            <div class="text-gray-800 font-semibold text-sm">₹{{ grand_total }}</div>
          </div>
        </div>
        <div class="text-center my-6">
          <img src="{% static './images/misc/payments.png' %}" class="h-8 mx-auto" alt="Payment Methods">
        </div>
        <div class="w-full text-white font-semibold py-2 my-2 text-sm bg-black text-center">
          <a href="/orders/proceed_payment/{{order.order_number}}" class="w-full">
            Continue
          </a>
        </div>
      </div>
    </div>
    <!-- ============================ COMPONENT 1 END .// ================================= -->
  </div>
</section>

<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  var amount = "{{ grand_total }}";
  var url = "{% url 'payments' %}";
  var csrftoken = getCookie('csrftoken');
  var orderID = "{{order.order_number}}";
  var payment_method = 'PayPal';
  var redirect_url = "{% url 'order_complete' %}";

  // Render the PayPal button into #paypal-button-container
  paypal.Buttons({
    style: {
      color: 'blue',
      shape: 'rect',
      label: 'pay',
      height: 40
    },

    // Set up the transaction
    createOrder: function(data, actions) {
      return actions.order.create({
        purchase_units: [{
          amount: {
            value: amount,
          }
        }]
      });
    },

    // Finalize the transaction
    onApprove: function(data, actions) {
      return actions.order.capture().then(function(details) {
        console.log(details);
        sendData();
        function sendData() {
          fetch(url, {
            method: "POST",
            headers: {
              "Content-type": "application/json",
              "X-CSRFToken": csrftoken,
            },
            body: JSON.stringify({
              orderID: orderID,
              transID: details.id,
              payment_method: payment_method,
              status: details.status,
            }),
          })
          .then((response) => response.json())
          .then((data) => {
            window.location.href = redirect_url + '?order_number=' + data.order_number + '&payment_id=' + data.transID;
          });
        }
      });
    }
  }).render('#paypal-button-container');
</script>
{% endblock %}